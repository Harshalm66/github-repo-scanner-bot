name: Scan Repository

on:
  repository_dispatch:
    types: [scan_command]
  
  workflow_dispatch:  # For manual testing
    inputs:
      repo_url:
        description: 'GitHub Repository URL to scan'
        required: true
        default: 'https://github.com/lodash/lodash'
        type: string

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: üìã Parse Repository URL
        id: parse
        run: |
          # Get URL from either manual trigger or API trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            URL="${{ github.event.inputs.repo_url }}"
          else
            URL="${{ github.event.client_payload.repo_url }}"
          fi
          
          echo "Processing URL: $URL"
          
          # Extract owner/repo from URL
          REPO=$(echo $URL | sed 's|https://github.com/||' | sed 's|\.git$||' | sed 's|/$||')
          
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "Parsed: $REPO"

      - name: üîΩ Clone Target Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parse.outputs.repo }}
          path: target-repo
          fetch-depth: 0  # Full history for better analysis

      - name: üìä Repository Information
        run: |
          echo "=================================="
          echo "Repository: ${{ steps.parse.outputs.repo }}"
          echo "URL: ${{ steps.parse.outputs.url }}"
          echo "=================================="
          cd target-repo
          echo "Files found:"
          find . -type f -name "*.js" -o -name "*.py" -o -name "*.java" -o -name "*.go" | head -20
          cd ..

      # CodeQL Analysis
      - name: üîç Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, python, java, go
          source-root: target-repo
        continue-on-error: true

      - name: üîç Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:multi"
          output: codeql-results
        continue-on-error: true

      # Semgrep Analysis
      - name: üõ°Ô∏è Run Semgrep
        continue-on-error: true
        run: |
          pip install semgrep
          cd target-repo
          semgrep --config=auto --json --output=../semgrep-results.json . || true
          semgrep --config=auto --sarif --output=../semgrep.sarif . || true
          cd ..
          
          if [ -f semgrep-results.json ]; then
            echo "‚úÖ Semgrep completed"
            FINDINGS=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            echo "Semgrep findings: $FINDINGS"
          fi

      # Bandit (Python Security)
      - name: üêç Run Bandit (Python)
        if: success() || failure()
        continue-on-error: true
        run: |
          pip install bandit
          bandit -r target-repo -f json -o bandit-report.json || true
          
          if [ -f bandit-report.json ]; then
            echo "‚úÖ Bandit completed"
          fi

      # njsscan (Node.js Security)
      - name: üì¶ Run njsscan (Node.js)
        if: success() || failure()
        continue-on-error: true
        run: |
          pip install njsscan
          njsscan target-repo --json --output njsscan-report.json || true
          
          if [ -f njsscan-report.json ]; then
            echo "‚úÖ njsscan completed"
          fi

      # Trivy (Vulnerabilities & Secrets)
      - name: üîê Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        if: success() || failure()
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: 'target-repo'
          format: 'json'
          output: 'trivy-results.json'

      # Safety (Python Dependencies)
      - name: üîí Run Safety (Python Dependencies)
        if: success() || failure()
        continue-on-error: true
        run: |
          if [ -f target-repo/requirements.txt ]; then
            pip install safety
            safety check --file target-repo/requirements.txt --json > safety-results.json || true
            echo "‚úÖ Safety scan completed"
          else
            echo "‚ÑπÔ∏è  No requirements.txt found, skipping Safety scan"
          fi

      # Generate Comprehensive Report
      - name: üìù Generate Final Report
        if: always()
        run: |
          cat << 'EOFMARKER' > final-report.md
          # üîí Security & Quality Scan Report
          
          **Repository:** ${{ steps.parse.outputs.repo }}  
          **URL:** ${{ steps.parse.outputs.url }}  
          **Scanned:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Workflow Run:** #${{ github.run_number }}
          
          ---
          
          ## üìä Executive Summary
          
          EOFMARKER
          
          # Add CodeQL results
          echo "### üîç CodeQL Analysis" >> final-report.md
          if [ -d codeql-results ]; then
            echo "- ‚úÖ CodeQL scan completed" >> final-report.md
            echo "- Results available in artifacts" >> final-report.md
          else
            echo "- ‚ö†Ô∏è CodeQL scan not completed or no issues found" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # Add Semgrep results
          echo "### üõ°Ô∏è Semgrep Findings" >> final-report.md
          if [ -f semgrep-results.json ]; then
            TOTAL=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            echo "- **Total findings:** $TOTAL" >> final-report.md
            
            if [ "$TOTAL" != "0" ] && [ "$TOTAL" != "null" ]; then
              echo "- **Severity breakdown:**" >> final-report.md
              HIGH=$(jq '[.results[] | select(.extra.severity=="ERROR")] | length' semgrep-results.json 2>/dev/null || echo "0")
              MEDIUM=$(jq '[.results[] | select(.extra.severity=="WARNING")] | length' semgrep-results.json 2>/dev/null || echo "0")
              echo "  - High: $HIGH" >> final-report.md
              echo "  - Medium: $MEDIUM" >> final-report.md
            fi
          else
            echo "- Status: Not run or no results" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # Add Bandit results
          echo "### üêç Bandit Analysis (Python)" >> final-report.md
          if [ -f bandit-report.json ]; then
            HIGH=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' bandit-report.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' bandit-report.json 2>/dev/null || echo "0")
            LOW=$(jq '[.results[] | select(.issue_severity=="LOW")] | length' bandit-report.json 2>/dev/null || echo "0")
            echo "- **High severity:** $HIGH" >> final-report.md
            echo "- **Medium severity:** $MEDIUM" >> final-report.md
            echo "- **Low severity:** $LOW" >> final-report.md
          else
            echo "- Status: No Python files or scan not run" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # Add njsscan results
          echo "### üì¶ njsscan Analysis (Node.js)" >> final-report.md
          if [ -f njsscan-report.json ]; then
            echo "- ‚úÖ Scan completed" >> final-report.md
            echo "- See artifacts for details" >> final-report.md
          else
            echo "- Status: No Node.js files or scan not run" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # Add Trivy results
          echo "### üîê Trivy Scan (Vulnerabilities & Secrets)" >> final-report.md
          if [ -f trivy-results.json ]; then
            echo "- ‚úÖ Scan completed" >> final-report.md
            VULNS=$(jq '[.Results[]?.Vulnerabilities[]?] | length' trivy-results.json 2>/dev/null || echo "0")
            echo "- **Vulnerabilities found:** $VULNS" >> final-report.md
          else
            echo "- Status: Scan not completed" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # Footer
          echo "---" >> final-report.md
          echo "" >> final-report.md
          echo "## üì¶ Detailed Reports" >> final-report.md
          echo "" >> final-report.md
          echo "Download full scan results from the **Artifacts** section below." >> final-report.md
          echo "" >> final-report.md
          echo "‚úÖ **Scan completed successfully**" >> final-report.md
          
          # Display report in logs
          echo ""
          echo "========================================="
          echo "FINAL REPORT:"
          echo "========================================="
          cat final-report.md
          echo "========================================="

      - name: üì§ Upload All Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results-${{ github.run_number }}
          path: |
            final-report.md
            semgrep-results.json
            semgrep.sarif
            bandit-report.json
            njsscan-report.json
            trivy-results.json
            safety-results.json
            codeql-results/
          retention-days: 30

      - name: ‚úÖ Workflow Complete
        if: always()
        run: |
          echo "========================================="
          echo "‚úÖ Security scan workflow completed!"
          echo "========================================="
          echo "üìä View the final report in workflow logs above"
          echo "üì¶ Download detailed results from Artifacts section"
          echo "========================================="
