name: Scan Repository

on:
  repository_dispatch:
    types: [process-url]
  
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'GitHub Repository URL to scan'
        required: true
        default: 'https://github.com/lodash/lodash'
        type: string

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“‹ Parse Repository URL
        id: parse
        run: |
          # Get URL from either manual trigger or API trigger
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            URL="${{ github.event.inputs.repo_url }}"
          else
            URL="${{ github.event.client_payload.repo_url }}"
          fi
          
          echo "Processing URL: $URL"
          
          # Extract owner/repo from URL
          REPO=$(echo $URL | sed 's|https://github.com/||' | sed 's|\.git$||' | sed 's|/$||')
          
          echo "repo=$REPO" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          echo "âœ… Parsed repository: $REPO"

      - name: ğŸ”½ Clone Target Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.parse.outputs.repo }}
          path: target-repo
          fetch-depth: 0

      - name: ğŸ“Š Repository Information
        run: |
          echo "============================================="
          echo "Repository: ${{ steps.parse.outputs.repo }}"
          echo "URL: ${{ steps.parse.outputs.url }}"
          echo "============================================="
          cd target-repo
          
          echo ""
          echo "ğŸ“ Repository structure:"
          ls -la | head -20
          
          echo ""
          echo "ğŸ“ File types detected:"
          find . -type f | sed 's/.*\.//' | sort | uniq -c | sort -rn | head -15
          
          echo ""
          echo "ğŸ“¦ Total files: $(find . -type f | wc -l)"
          echo "============================================="
          cd ..

      - name: ğŸ” Detect Languages for CodeQL
        id: detect-languages
        run: |
          cd target-repo
          LANGUAGES=""
          
          echo "Detecting languages..."
          echo ""
          
          # Check for JavaScript/TypeScript
          if find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | grep -q .; then
            LANGUAGES="$LANGUAGES javascript"
            JS_COUNT=$(find . -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" | wc -l)
            echo "âœ… JavaScript/TypeScript detected ($JS_COUNT files)"
          fi
          
          # Check for Python
          if find . -name "*.py" | grep -q .; then
            LANGUAGES="$LANGUAGES python"
            PY_COUNT=$(find . -name "*.py" | wc -l)
            echo "âœ… Python detected ($PY_COUNT files)"
          fi
          
          # Check for Java
          if find . -name "*.java" | grep -q .; then
            LANGUAGES="$LANGUAGES java"
            JAVA_COUNT=$(find . -name "*.java" | wc -l)
            echo "âœ… Java detected ($JAVA_COUNT files)"
          fi
          
          # Check for Go
          if find . -name "*.go" | grep -q .; then
            LANGUAGES="$LANGUAGES go"
            GO_COUNT=$(find . -name "*.go" | wc -l)
            echo "âœ… Go detected ($GO_COUNT files)"
          fi
          
          # Check for C/C++
          if find . -name "*.c" -o -name "*.cpp" -o -name "*.h" -o -name "*.hpp" | grep -q .; then
            LANGUAGES="$LANGUAGES cpp"
            CPP_COUNT=$(find . -name "*.c" -o -name "*.cpp" -o -name "*.h" | wc -l)
            echo "âœ… C/C++ detected ($CPP_COUNT files)"
          fi
          
          # Check for C#
          if find . -name "*.cs" | grep -q .; then
            LANGUAGES="$LANGUAGES csharp"
            CS_COUNT=$(find . -name "*.cs" | wc -l)
            echo "âœ… C# detected ($CS_COUNT files)"
          fi
          
          # Check for Ruby
          if find . -name "*.rb" | grep -q .; then
            LANGUAGES="$LANGUAGES ruby"
            RB_COUNT=$(find . -name "*.rb" | wc -l)
            echo "âœ… Ruby detected ($RB_COUNT files)"
          fi
          
          cd ..
          
          # Clean up extra spaces
          LANGUAGES=$(echo $LANGUAGES | xargs)
          
          if [ -z "$LANGUAGES" ]; then
            echo ""
            echo "âš ï¸  No CodeQL-supported languages detected"
            echo "languages=none" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "ğŸ¯ CodeQL will scan: $LANGUAGES"
            echo "languages=$LANGUAGES" >> $GITHUB_OUTPUT
          fi

      # CodeQL Analysis (only if supported languages detected)
      - name: ğŸ” Initialize CodeQL
        if: steps.detect-languages.outputs.languages != 'none'
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ steps.detect-languages.outputs.languages }}
          source-root: target-repo
        continue-on-error: true

      - name: ğŸ” Perform CodeQL Analysis
        if: steps.detect-languages.outputs.languages != 'none'
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ steps.detect-languages.outputs.languages }}"
        continue-on-error: true

      # Semgrep - Universal SAST
      - name: ğŸ›¡ï¸ Run Semgrep (Universal SAST)
        continue-on-error: true
        run: |
          echo "Installing Semgrep..."
          pip install semgrep
          
          echo "Running Semgrep scan..."
          cd target-repo
          
          # Run with JSON output
          semgrep --config=auto --json --output=../semgrep-results.json . || true
          
          # Run with SARIF output for GitHub integration
          semgrep --config=auto --sarif --output=../semgrep.sarif . || true
          
          cd ..
          
          if [ -f semgrep-results.json ]; then
            FINDINGS=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            echo "âœ… Semgrep completed: $FINDINGS findings"
          else
            echo "âš ï¸  Semgrep completed with warnings"
          fi

      # Bandit - Python Security
      - name: ğŸ Run Bandit (Python Security)
        if: contains(steps.detect-languages.outputs.languages, 'python')
        continue-on-error: true
        run: |
          echo "Installing Bandit..."
          pip install bandit
          
          echo "Running Bandit Python security scan..."
          bandit -r target-repo -f json -o bandit-report.json || true
          
          if [ -f bandit-report.json ]; then
            HIGH=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' bandit-report.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' bandit-report.json 2>/dev/null || echo "0")
            echo "âœ… Bandit completed: $HIGH high, $MEDIUM medium severity issues"
          fi

      # njsscan - Node.js/JavaScript Security
      - name: ğŸ“¦ Run njsscan (Node.js Security)
        if: contains(steps.detect-languages.outputs.languages, 'javascript')
        continue-on-error: true
        run: |
          echo "Installing njsscan..."
          pip install njsscan
          
          echo "Running njsscan..."
          njsscan target-repo --json --output njsscan-report.json || true
          
          if [ -f njsscan-report.json ]; then
            ISSUES=$(jq '.total_count.sec // 0' njsscan-report.json 2>/dev/null || echo "0")
            echo "âœ… njsscan completed: $ISSUES security issues found"
          fi

      # Trivy - Vulnerabilities, Secrets, and Misconfigurations
      - name: ğŸ” Run Trivy (Vulnerabilities & Secrets)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: 'target-repo'
          format: 'json'
          output: 'trivy-results.json'
          severity: 'CRITICAL,HIGH,MEDIUM,LOW'

      - name: ğŸ” Run Trivy (Secrets Detection)
        uses: aquasecurity/trivy-action@master
        continue-on-error: true
        with:
          scan-type: 'fs'
          scan-ref: 'target-repo'
          scanners: 'secret'
          format: 'json'
          output: 'trivy-secrets.json'

      # Safety - Python Dependencies
      - name: ğŸ”’ Run Safety (Python Dependencies)
        if: contains(steps.detect-languages.outputs.languages, 'python')
        continue-on-error: true
        run: |
          if [ -f target-repo/requirements.txt ]; then
            echo "Installing Safety..."
            pip install safety
            
            echo "Checking Python dependencies..."
            safety check --file target-repo/requirements.txt --json > safety-results.json || true
            
            if [ -f safety-results.json ]; then
              echo "âœ… Safety scan completed"
            fi
          else
            echo "â„¹ï¸  No requirements.txt found, skipping Safety scan"
          fi

      # npm audit - Node.js Dependencies
      - name: ğŸ“¦ Run npm audit (Node.js Dependencies)
        if: contains(steps.detect-languages.outputs.languages, 'javascript')
        continue-on-error: true
        run: |
          if [ -f target-repo/package.json ]; then
            echo "Running npm audit..."
            cd target-repo
            
            # Install dependencies first
            npm install --package-lock-only || true
            
            # Run audit
            npm audit --json > ../npm-audit.json || true
            
            cd ..
            
            if [ -f npm-audit.json ]; then
              VULNS=$(jq '.metadata.vulnerabilities.total // 0' npm-audit.json 2>/dev/null || echo "0")
              echo "âœ… npm audit completed: $VULNS vulnerabilities found"
            fi
          else
            echo "â„¹ï¸  No package.json found, skipping npm audit"
          fi

      # Generate Comprehensive Report
      - name: ğŸ“ Generate Final Report
        if: always()
        run: |
          cat << 'EOFMARKER' > final-report.md
          # ğŸ”’ Security & Quality Scan Report
          
          **Repository:** ${{ steps.parse.outputs.repo }}  
          **URL:** ${{ steps.parse.outputs.url }}  
          **Scanned:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Workflow Run:** #${{ github.run_number }}  
          **Triggered by:** ${{ github.event_name }}
          
          ---
          
          ## ğŸ“Š Executive Summary
          
          EOFMARKER
          
          # Initialize counters
          TOTAL_CRITICAL=0
          TOTAL_HIGH=0
          TOTAL_MEDIUM=0
          TOTAL_LOW=0
          TOTAL_SECRETS=0
          
          # Trivy Vulnerabilities
          echo "### ğŸ” Trivy - Vulnerability Scan" >> final-report.md
          if [ -f trivy-results.json ]; then
            RESULTS_COUNT=$(jq '.Results | length' trivy-results.json 2>/dev/null || echo "0")
            
            if [ "$RESULTS_COUNT" = "0" ] || [ "$RESULTS_COUNT" = "null" ]; then
              echo "- âœ… **No vulnerabilities detected**" >> final-report.md
            else
              CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-results.json 2>/dev/null || echo "0")
              HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-results.json 2>/dev/null || echo "0")
              MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-results.json 2>/dev/null || echo "0")
              LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-results.json 2>/dev/null || echo "0")
              
              TOTAL_CRITICAL=$((TOTAL_CRITICAL + CRITICAL))
              TOTAL_HIGH=$((TOTAL_HIGH + HIGH))
              TOTAL_MEDIUM=$((TOTAL_MEDIUM + MEDIUM))
              TOTAL_LOW=$((TOTAL_LOW + LOW))
              
              echo "- ğŸ”´ **Critical:** $CRITICAL" >> final-report.md
              echo "- ğŸŸ  **High:** $HIGH" >> final-report.md
              echo "- ğŸŸ¡ **Medium:** $MEDIUM" >> final-report.md
              echo "- ğŸŸ¢ **Low:** $LOW" >> final-report.md
              
              # List top critical/high issues
              if [ "$CRITICAL" != "0" ] || [ "$HIGH" != "0" ]; then
                echo "" >> final-report.md
                echo "#### ğŸš¨ Top Critical/High Vulnerabilities:" >> final-report.md
                jq -r '.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH") | "- **\(.VulnerabilityID)**: \(.Title // .PkgName) (\(.Severity))"' trivy-results.json 2>/dev/null | head -5 >> final-report.md || true
              fi
            fi
          else
            echo "- âš ï¸ Scan did not complete" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # Trivy Secrets
          echo "### ğŸ”‘ Trivy - Secrets Detection" >> final-report.md
          if [ -f trivy-secrets.json ]; then
            SECRETS=$(jq '[.Results[]?.Secrets[]?] | length' trivy-secrets.json 2>/dev/null || echo "0")
            TOTAL_SECRETS=$SECRETS
            
            if [ "$SECRETS" = "0" ]; then
              echo "- âœ… **No secrets detected**" >> final-report.md
            else
              echo "- ğŸ”‘ **Secrets found:** $SECRETS" >> final-report.md
              echo "" >> final-report.md
              echo "#### Detected Secrets:" >> final-report.md
              jq -r '.Results[]?.Secrets[]? | "- **\(.Title)** in `\(.Target)` (Line \(.StartLine // "unknown"))"' trivy-secrets.json 2>/dev/null | head -10 >> final-report.md || true
            fi
          else
            echo "- âœ… No secrets detected" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # CodeQL
          echo "### ğŸ” CodeQL Analysis" >> final-report.md
          if [ "${{ steps.detect-languages.outputs.languages }}" != "none" ]; then
            echo "- âœ… **Languages scanned:** ${{ steps.detect-languages.outputs.languages }}" >> final-report.md
            echo "- ğŸ“Š Results available in GitHub Security tab (Code Scanning Alerts)" >> final-report.md
          else
            echo "- âš ï¸ No CodeQL-supported languages detected in repository" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # Semgrep
          echo "### ğŸ›¡ï¸ Semgrep - SAST Analysis" >> final-report.md
          if [ -f semgrep-results.json ]; then
            TOTAL=$(jq '.results | length' semgrep-results.json 2>/dev/null || echo "0")
            echo "- **Total findings:** $TOTAL" >> final-report.md
            
            if [ "$TOTAL" != "0" ] && [ "$TOTAL" != "null" ]; then
              ERROR=$(jq '[.results[] | select(.extra.severity=="ERROR")] | length' semgrep-results.json 2>/dev/null || echo "0")
              WARNING=$(jq '[.results[] | select(.extra.severity=="WARNING")] | length' semgrep-results.json 2>/dev/null || echo "0")
              INFO=$(jq '[.results[] | select(.extra.severity=="INFO")] | length' semgrep-results.json 2>/dev/null || echo "0")
              
              echo "  - ğŸ”´ **Error:** $ERROR" >> final-report.md
              echo "  - ğŸŸ¡ **Warning:** $WARNING" >> final-report.md
              echo "  - ğŸ”µ **Info:** $INFO" >> final-report.md
              
              TOTAL_HIGH=$((TOTAL_HIGH + ERROR))
              TOTAL_MEDIUM=$((TOTAL_MEDIUM + WARNING))
              
              # Show top issues
              if [ "$ERROR" != "0" ] || [ "$WARNING" != "0" ]; then
                echo "" >> final-report.md
                echo "#### Top Issues:" >> final-report.md
                jq -r '.results[0:5] | .[] | "- **\(.check_id)** in `\(.path)` (Line \(.start.line)): \(.extra.message // "Security issue detected")"' semgrep-results.json 2>/dev/null >> final-report.md || true
              fi
            else
              echo "- âœ… No issues found" >> final-report.md
            fi
          else
            echo "- âš ï¸ Scan not completed" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # Bandit
          echo "### ğŸ Bandit - Python Security" >> final-report.md
          if [ -f bandit-report.json ]; then
            HIGH=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' bandit-report.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' bandit-report.json 2>/dev/null || echo "0")
            LOW=$(jq '[.results[] | select(.issue_severity=="LOW")] | length' bandit-report.json 2>/dev/null || echo "0")
            
            echo "- ğŸ”´ **High:** $HIGH" >> final-report.md
            echo "- ğŸŸ¡ **Medium:** $MEDIUM" >> final-report.md
            echo "- ğŸŸ¢ **Low:** $LOW" >> final-report.md
            
            TOTAL_HIGH=$((TOTAL_HIGH + HIGH))
            TOTAL_MEDIUM=$((TOTAL_MEDIUM + MEDIUM))
            TOTAL_LOW=$((TOTAL_LOW + LOW))
            
            if [ "$HIGH" != "0" ]; then
              echo "" >> final-report.md
              echo "#### High Severity Issues:" >> final-report.md
              jq -r '.results[] | select(.issue_severity=="HIGH") | "- **\(.test_id)**: \(.issue_text) in `\(.filename)` (Line \(.line_number))"' bandit-report.json 2>/dev/null | head -5 >> final-report.md || true
            fi
          else
            echo "- Not applicable (no Python files detected)" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # njsscan
          echo "### ğŸ“¦ njsscan - Node.js Security" >> final-report.md
          if [ -f njsscan-report.json ]; then
            ISSUES=$(jq '.total_count.sec // 0' njsscan-report.json 2>/dev/null || echo "0")
            echo "- **Security issues:** $ISSUES" >> final-report.md
            
            if [ "$ISSUES" != "0" ]; then
              TOTAL_MEDIUM=$((TOTAL_MEDIUM + ISSUES))
            fi
          else
            echo "- Not applicable (no JavaScript/Node.js files detected)" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # npm audit
          echo "### ğŸ“¦ npm audit - Node.js Dependencies" >> final-report.md
          if [ -f npm-audit.json ]; then
            CRITICAL=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit.json 2>/dev/null || echo "0")
            HIGH=$(jq '.metadata.vulnerabilities.high // 0' npm-audit.json 2>/dev/null || echo "0")
            MODERATE=$(jq '.metadata.vulnerabilities.moderate // 0' npm-audit.json 2>/dev/null || echo "0")
            
            echo "- ğŸ”´ **Critical:** $CRITICAL" >> final-report.md
            echo "- ğŸŸ  **High:** $HIGH" >> final-report.md
            echo "- ğŸŸ¡ **Moderate:** $MODERATE" >> final-report.md
            
            TOTAL_CRITICAL=$((TOTAL_CRITICAL + CRITICAL))
            TOTAL_HIGH=$((TOTAL_HIGH + HIGH))
            TOTAL_MEDIUM=$((TOTAL_MEDIUM + MODERATE))
          else
            echo "- Not applicable (no package.json found)" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # Safety
          echo "### ğŸ”’ Safety - Python Dependencies" >> final-report.md
          if [ -f safety-results.json ]; then
            VULNS=$(jq 'length' safety-results.json 2>/dev/null || echo "0")
            
            if [ "$VULNS" = "0" ]; then
              echo "- âœ… No known vulnerabilities in Python dependencies" >> final-report.md
            else
              echo "- âš ï¸  **Vulnerable packages:** $VULNS" >> final-report.md
              TOTAL_HIGH=$((TOTAL_HIGH + VULNS))
            fi
          else
            echo "- Not applicable (no requirements.txt found)" >> final-report.md
          fi
          echo "" >> final-report.md
          
          # Overall Summary
          echo "---" >> final-report.md
          echo "" >> final-report.md
          echo "## ğŸ¯ Overall Risk Assessment" >> final-report.md
          echo "" >> final-report.md
          
          TOTAL_ISSUES=$((TOTAL_CRITICAL + TOTAL_HIGH + TOTAL_MEDIUM + TOTAL_LOW + TOTAL_SECRETS))
          
          echo "**Total Issues Found:** $TOTAL_ISSUES" >> final-report.md
          echo "" >> final-report.md
          
          if [ $TOTAL_CRITICAL -gt 0 ]; then
            echo "### ğŸ”´ **CRITICAL RISK**" >> final-report.md
            echo "" >> final-report.md
            echo "âš ï¸  **$TOTAL_CRITICAL critical issues require immediate attention!**" >> final-report.md
            echo "" >> final-report.md
            echo "**Breakdown:**" >> final-report.md
            echo "- ğŸ”´ Critical: $TOTAL_CRITICAL" >> final-report.md
            echo "- ğŸŸ  High: $TOTAL_HIGH" >> final-report.md
            echo "- ğŸŸ¡ Medium: $TOTAL_MEDIUM" >> final-report.md
            echo "- ğŸŸ¢ Low: $TOTAL_LOW" >> final-report.md
            echo "- ğŸ”‘ Secrets: $TOTAL_SECRETS" >> final-report.md
          elif [ $TOTAL_HIGH -gt 10 ]; then
            echo "### ğŸŸ  **HIGH RISK**" >> final-report.md
            echo "" >> final-report.md
            echo "**$TOTAL_HIGH high-severity issues found**" >> final-report.md
            echo "" >> final-report.md
            echo "**Breakdown:**" >> final-report.md
            echo "- ğŸŸ  High: $TOTAL_HIGH" >> final-report.md
            echo "- ğŸŸ¡ Medium: $TOTAL_MEDIUM" >> final-report.md
            echo "- ğŸŸ¢ Low: $TOTAL_LOW" >> final-report.md
            echo "- ğŸ”‘ Secrets: $TOTAL_SECRETS" >> final-report.md
          elif [ $TOTAL_MEDIUM -gt 20 ]; then
            echo "### ğŸŸ¡ **MEDIUM RISK**" >> final-report.md
            echo "" >> final-report.md
            echo "Multiple medium-severity issues detected" >> final-report.md
            echo "" >> final-report.md
            echo "**Breakdown:**" >> final-report.md
            echo "- ğŸŸ¡ Medium: $TOTAL_MEDIUM" >> final-report.md
            echo "- ğŸŸ¢ Low: $TOTAL_LOW" >> final-report.md
            echo "- ğŸ”‘ Secrets: $TOTAL_SECRETS" >> final-report.md
          elif [ $TOTAL_ISSUES -eq 0 ]; then
            echo "### âœ… **LOW RISK - EXCELLENT!**" >> final-report.md
            echo "" >> final-report.md
            echo "ğŸ‰ **No significant security issues detected!**" >> final-report.md
            echo "" >> final-report.md
            echo "This repository appears to follow security best practices:" >> final-report.md
            echo "- âœ… No critical or high vulnerabilities" >> final-report.md
            echo "- âœ… No secrets exposed" >> final-report.md
            echo "- âœ… No major code quality issues" >> final-report.md
            echo "- âœ… Dependencies are up to date" >> final-report.md
          else
            echo "### ğŸŸ¢ **LOW-MEDIUM RISK**" >> final-report.md
            echo "" >> final-report.md
            echo "Minor issues found, but overall security posture is good" >> final-report.md
            echo "" >> final-report.md
            echo "**Breakdown:**" >> final-report.md
            echo "- ğŸŸ¡ Medium: $TOTAL_MEDIUM" >> final-report.md
            echo "- ğŸŸ¢ Low: $TOTAL_LOW" >> final-report.md
            if [ $TOTAL_SECRETS -gt 0 ]; then
              echo "- ğŸ”‘ Secrets: $TOTAL_SECRETS âš ï¸" >> final-report.md
            fi
          fi
          
          echo "" >> final-report.md
          echo "---" >> final-report.md
          echo "" >> final-report.md
          echo "## ğŸ“‹ Recommended Actions" >> final-report.md
          echo "" >> final-report.md
          
          if [ $TOTAL_CRITICAL -gt 0 ]; then
            echo "### Immediate (Critical):" >> final-report.md
            echo "1. ğŸš¨ Review and fix all CRITICAL vulnerabilities immediately" >> final-report.md
            echo "2. ğŸ”’ Rotate any exposed secrets/credentials" >> final-report.md
            echo "3. ğŸ” Conduct thorough security review" >> final-report.md
            echo "" >> final-report.md
          fi
          
          if [ $TOTAL_HIGH -gt 0 ]; then
            echo "### High Priority:" >> final-report.md
            echo "1. ğŸ”§ Address HIGH severity issues within 7 days" >> final-report.md
            echo "2. ğŸ“¦ Update vulnerable dependencies" >> final-report.md
            echo "3. ğŸ›¡ï¸ Review Semgrep and Bandit findings" >> final-report.md
            echo "" >> final-report.md
          fi
          
          echo "### Regular Maintenance:" >> final-report.md
          echo "1. ğŸ“¥ Download detailed reports from Artifacts section below" >> final-report.md
          echo "2. ğŸ“Š Review SARIF files for complete findings" >> final-report.md
          echo "3. ğŸ”„ Run this scan regularly (recommended: weekly)" >> final-report.md
          echo "4. ğŸ“ˆ Track security improvements over time" >> final-report.md
          
          echo "" >> final-report.md
          echo "---" >> final-report.md
          echo "" >> final-report.md
          echo "## ğŸ“¦ Detailed Reports Available" >> final-report.md
          echo "" >> final-report.md
          echo "Download the artifacts below for:" >> final-report.md
          echo "- ğŸ“„ Complete JSON reports from all tools" >> final-report.md
          echo "- ğŸ“Š SARIF files for IDE integration" >> final-report.md
          echo "- ğŸ” Line-by-line vulnerability details" >> final-report.md
          echo "- ğŸ“ˆ Exportable data for tracking" >> final-report.md
          echo "" >> final-report.md
          echo "---" >> final-report.md
          echo "" >> final-report.md
          echo "**Scan completed:** $(date -u)" >> final-report.md
          echo "**Workflow:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> final-report.md
          echo "" >> final-report.md
          echo "âœ… **Security scan completed successfully!**" >> final-report.md
          
          # Display in logs
          echo ""
          echo "============================================="
          echo "        FINAL SECURITY REPORT"
          echo "============================================="
          cat final-report.md
          echo "============================================="

      - name: ğŸ“¤ Upload All Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results-${{ github.run_number }}
          path: |
            final-report.md
            semgrep-results.json
            semgrep.sarif
            bandit-report.json
            njsscan-report.json
            trivy-results.json
            trivy-secrets.json
            safety-results.json
            npm-audit.json
          retention-days: 30

      - name: âœ… Workflow Summary
        if: always()
        run: |
          echo ""
          echo "============================================="
          echo "âœ… Security Scan Workflow Completed!"
          echo "============================================="
          echo ""
          echo "ğŸ“Š Repository scanned: ${{ steps.parse.outputs.repo }}"
          echo "ğŸ• Completed at: $(date -u)"
          echo "ğŸ”¢ Run number: ${{ github.run_number }}"
          echo ""
          echo "ğŸ“¥ Download detailed results:"
          echo "   â†’ Go to Actions tab"
          echo "   â†’ Click this workflow run"
          echo "   â†’ Scroll to Artifacts section"
          echo "   â†’ Download: security-scan-results-${{ github.run_number }}"
          echo ""
          echo "ğŸ¯ View summary report in the logs above"
          echo "============================================="
